<div class="statistiques-container fade-in">
  <!-- Header -->
  <div class="page-header mb-4">
    <div>
      <h2 class="fw-bold">
        <i class="fas fa-chart-line me-2"></i>Statistiques du Département
      </h2>
      <p class="text-muted">
        Analyse détaillée de {{ stats?.departement?.nom_departement || currentUser?.departement }}
      </p>
    </div>
    <button class="btn btn-primary btn-modern" (click)="exportStats()">
      <i class="fas fa-file-pdf me-2"></i>Exporter PDF
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-success" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  </div>

  <!-- Stats -->
  <div *ngIf="!loading && stats">
    <!-- Stats Cards Principales -->
    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="stat-card modern-card">
          <div class="stat-icon bg-primary">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-number">{{ stats.total_documents || 0 }}</h3>
            <p class="stat-label">Documents Total</p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="stat-card modern-card">
          <div class="stat-icon bg-success">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-number">{{ stats.total_employes || 0 }}</h3>
            <p class="stat-label">Employés Actifs</p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="stat-card modern-card">
          <div class="stat-icon bg-info">
            <i class="fas fa-database"></i>
          </div>
          <div class="stat-info">
            <h3 class="stat-number">{{ formatBytes(stats.volume_stockage || 0) }}</h3>
            <p class="stat-label">Stockage Utilisé</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents par Type -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="modern-card p-4">
          <h5 class="mb-4 fw-bold">
            <i class="fas fa-chart-pie me-2"></i>Documents par Type
          </h5>
          <div class="types-list">
            <div class="type-item" *ngFor="let type of stats.documents_par_type">
              <div class="type-info">
                <span class="type-name">{{ type.libelle_type }}</span>
                <span class="type-count">{{ type.total }} documents</span>
              </div>
              <div class="progress" style="height: 8px; flex: 1; max-width: 200px;">
                <div
                  class="progress-bar"
                  [ngClass]="getProgressColor(type.total, stats.total_documents)"
                  [style.width.%]="(type.total / stats.total_documents) * 100">
                </div>
              </div>
            </div>

            <div *ngIf="!stats.documents_par_type || stats.documents_par_type.length === 0" class="text-center py-4">
              <i class="fas fa-file fa-3x text-muted mb-3"></i>
              <p class="text-muted">Aucun document</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Activité par Employé -->
      <div class="col-md-6">
        <div class="modern-card p-4">
          <h5 class="mb-4 fw-bold">
            <i class="fas fa-user-check me-2"></i>Activité par Employé
          </h5>
          <div class="employes-activity-list">
            <div class="employe-activity-item" *ngFor="let employe of stats.activite_par_employe; let i = index">
              <div class="employe-rank" [class.top-rank]="i < 3">
                {{ i + 1 }}
              </div>
              <div class="employe-details">
                <strong>{{ employe.nom_complet }}</strong>
                <small class="text-muted">{{ employe.total_actions }} actions</small>
              </div>
              <div class="employe-badge">
                <span class="badge bg-primary">{{ employe.total_actions }}</span>
              </div>
            </div>

            <div *ngIf="!stats.activite_par_employe || stats.activite_par_employe.length === 0" class="text-center py-4">
              <i class="fas fa-users fa-3x text-muted mb-3"></i>
              <p class="text-muted">Aucune activité</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Récents -->
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="modern-card p-4">
          <h5 class="mb-4 fw-bold">
            <i class="fas fa-clock me-2"></i>Activité Récente
          </h5>
          <div class="recent-documents">
            <div class="recent-doc-item" *ngFor="let doc of stats.documents_recents">
              <div class="recent-doc-icon">
                <i class="fas fa-file fa-2x text-primary"></i>
              </div>
              <div class="recent-doc-info">
                <strong>{{ doc.titre }}</strong>
                <p class="text-muted mb-0">
                  <small>
                    <i class="fas fa-clock me-1"></i>{{ formatDate(doc.created_at) }}
                  </small>
                </p>
              </div>
              <button class="btn btn-sm btn-outline-primary" routerLink="/chef/documentsChef">
                <i class="fas fa-eye"></i>
              </button>
            </div>

            <div *ngIf="!stats.documents_recents || stats.documents_recents.length === 0" class="text-center py-4">
              <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
              <p class="text-muted">Aucun document récent</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Indicateurs de Performance -->
    <div class="row g-4">
      <div class="col-md-12">
        <div class="modern-card p-4">
          <h5 class="mb-4 fw-bold">
            <i class="fas fa-tachometer-alt me-2"></i>Indicateurs de Performance
          </h5>
          <div class="row g-4">
            <div class="col-md-3">
              <div class="kpi-card">
                <div class="kpi-icon bg-success">
                  <i class="fas fa-arrow-up"></i>
                </div>
                <div class="kpi-info">
                  <h4 class="kpi-value text-success">+15%</h4>
                  <p class="kpi-label">Croissance documents</p>
                  <small class="text-muted">vs mois dernier</small>
                </div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="kpi-card">
                <div class="kpi-icon bg-primary">
                  <i class="fas fa-users"></i>
                </div>
                <div class="kpi-info">
                  <h4 class="kpi-value text-primary">{{ stats.total_employes || 0 }}</h4>
                  <p class="kpi-label">Employés actifs</p>
                  <small class="text-muted">100% du département</small>
                </div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="kpi-card">
                <div class="kpi-icon bg-warning">
                  <i class="fas fa-download"></i>
                </div>
                <div class="kpi-info">
                  <!-- ✅ CORRIGÉ : Utiliser Math depuis le composant -->
                  <h4 class="kpi-value text-warning">{{ Math.floor((stats.total_documents || 0) * 2.5) }}</h4>
                  <p class="kpi-label">Téléchargements</p>
                  <small class="text-muted">Ce mois-ci (estimation)</small>
                </div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="kpi-card">
                <div class="kpi-icon bg-info">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="kpi-info">
                  <!-- ✅ CORRIGÉ : Utiliser Math depuis le composant -->
                  <h4 class="kpi-value text-info">
                    {{ Math.floor((stats.total_documents || 0) / (stats.total_employes || 1)) }}
                  </h4>
                  <p class="kpi-label">Docs par employé</p>
                  <small class="text-muted">Moyenne</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message si pas de stats -->
  <div *ngIf="!loading && !stats" class="text-center py-5">
    <div class="modern-card p-5">
      <i class="fas fa-chart-bar fa-5x text-muted mb-3"></i>
      <h4>Aucune statistique disponible</h4>
      <p class="text-muted">Les statistiques de votre département ne sont pas encore disponibles.</p>
    </div>
  </div>
</div>
